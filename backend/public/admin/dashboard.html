<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理仪表盘 - 视频编辑器</title>
    <link rel="stylesheet" href="/admin/css/style.css">
</head>
<body>
    <div class="layout">
        <div class="sidebar">
            <div class="logo">
                <h1>视频编辑器</h1>
            </div>
            <ul class="nav-menu">
                <li class="active"><a href="/admin/dashboard.html">仪表盘</a></li>
                <li><a href="/admin/users.html">用户管理</a></li>
                <li><a href="/admin/videos.html">视频管理</a></li>
                <li><a href="/admin/templates.html">模板管理</a></li>
                <li><a href="/admin/categories.html">分类管理</a></li>
                <li><a href="/admin/settings.html">系统设置</a></li>
            </ul>
        </div>
        <div class="content">
            <div class="header">
                <h2>管理仪表盘</h2>
                <div class="header-right">
                    <span id="admin-name">管理员：加载中...</span>
                    <button class="logout-btn" id="logout-btn">退出登录</button>
                </div>
            </div>
            
            <div class="card-grid">
                <div class="stat-card">
                    <div class="stat-card-icon" style="background-color: #1890ff;">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path>
                        </svg>
                    </div>
                    <div class="stat-card-content">
                        <h3>总用户数</h3>
                        <div class="stat-value" id="total-users">加载中...</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-card-icon" style="background-color: #52c41a;">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
                            <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z"></path>
                        </svg>
                    </div>
                    <div class="stat-card-content">
                        <h3>视频数量</h3>
                        <div class="stat-value" id="total-videos">加载中...</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-card-icon" style="background-color: #fa8c16;">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 15.5h-1.5V14h-1v3H8v-3H7v4.5H5.5v-5c0-.55.45-1 1-1H11c.55 0 1 .45 1 1v5zm3.5 0H14v-6h3.5c.55 0 1 .45 1 1V16c0 .55-.45 1-1 1h-2v1.5zm-1-4.5H17v1h-2.5v-1zM13 9H9.5v1h2v1h-2v1H13V9zm9 8.5h-1.5v-1.25h-1.5V18H17v-5h5V13h-4v1h2.5v1H19v1.25h1.5V17H22v1.5z"></path>
                        </svg>
                    </div>
                    <div class="stat-card-content">
                        <h3>模板数量</h3>
                        <div class="stat-value" id="total-templates">加载中...</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-card-icon" style="background-color: #f5222d;">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
                            <path d="M2.53 19.65l1.34.56v-9.03l-2.43 5.86c-.41 1.02.08 2.19 1.09 2.61zm19.5-3.7L17.07 3.98c-.31-.75-1.04-1.21-1.81-1.23-.26 0-.53.04-.79.15L7.1 5.95c-.75.31-1.21 1.03-1.23 1.8-.01.27.04.54.15.8l4.96 11.97c.31.76 1.05 1.22 1.83 1.23.26 0 .52-.05.77-.15l7.36-3.05c1.02-.42 1.51-1.59 1.09-2.6zM7.88 8.75c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-2 11c0 1.1.9 2 2 2h1.45l-3.45-8.34v6.34z"></path>
                        </svg>
                    </div>
                    <div class="stat-card-content">
                        <h3>分类数量</h3>
                        <div class="stat-value" id="total-categories">加载中...</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3 class="card-title">最近注册用户</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>用户名</th>
                            <th>邮箱</th>
                            <th>注册时间</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody id="recent-users-table-body">
                        <tr>
                            <td colspan="5" style="text-align: center;">加载中...</td>
                        </tr>
                    </tbody>
                </table>
                <div style="text-align: right; margin-top: 15px;">
                    <a href="/admin/users.html" class="button">查看全部用户</a>
                </div>
            </div>
            
            <div class="card">
                <h3 class="card-title">最新上传视频</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>缩略图</th>
                            <th>标题</th>
                            <th>上传者</th>
                            <th>上传时间</th>
                            <th>时长</th>
                        </tr>
                    </thead>
                    <tbody id="recent-videos-table-body">
                        <tr>
                            <td colspan="6" style="text-align: center;">加载中...</td>
                        </tr>
                    </tbody>
                </table>
                <div style="text-align: right; margin-top: 15px;">
                    <a href="/admin/videos.html" class="button">查看全部视频</a>
                </div>
            </div>
            
            <div class="card">
                <h3 class="card-title">系统状态</h3>
                <div class="system-info">
                    <div class="system-info-item">
                        <span class="system-info-label">Node.js版本：</span>
                        <span class="system-info-value" id="node-version">加载中...</span>
                    </div>
                    <div class="system-info-item">
                        <span class="system-info-label">操作系统：</span>
                        <span class="system-info-value" id="os-info">加载中...</span>
                    </div>
                    <div class="system-info-item">
                        <span class="system-info-label">内存使用：</span>
                        <span class="system-info-value" id="memory-usage">加载中...</span>
                    </div>
                    <div class="system-info-item">
                        <span class="system-info-label">数据库大小：</span>
                        <span class="system-info-value" id="db-size">加载中...</span>
                    </div>
                    <div class="system-info-item">
                        <span class="system-info-label">上传文件总大小：</span>
                        <span class="system-info-value" id="upload-size">加载中...</span>
                    </div>
                    <div class="system-info-item">
                        <span class="system-info-label">服务运行时间：</span>
                        <span class="system-info-value" id="uptime">加载中...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let adminUsername = '';
        
        // 验证登录状态
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    window.location.href = '/admin/index.html';
                    return;
                }
                
                const data = await response.json();
                if (!data.data.is_admin) {
                    window.location.href = '/admin/index.html';
                    return;
                }
                
                // 显示管理员名称
                adminUsername = data.data.username;
                document.getElementById('admin-name').textContent = `管理员：${adminUsername}`;
                
                // 加载仪表盘数据
                loadDashboardData();
            } catch (error) {
                console.error('认证检查失败:', error);
                window.location.href = '/admin/index.html';
            }
        }
        
        // 加载仪表盘数据
        async function loadDashboardData() {
            try {
                // 获取统计数据
                const statsResponse = await fetch('/api/stats', {
                    credentials: 'include'
                });
                
                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    const stats = statsData.data;
                    
                    // 更新统计卡片
                    document.getElementById('total-users').textContent = stats.userCount || '0';
                    document.getElementById('total-videos').textContent = stats.videoCount || '0';
                    document.getElementById('total-templates').textContent = stats.templateCount || '0';
                    document.getElementById('total-categories').textContent = stats.categoryCount || '0';
                }
                
                // 加载最近用户
                loadRecentUsers();
                
                // 加载最新视频
                loadRecentVideos();
                
                // 加载系统信息
                loadSystemInfo();
            } catch (error) {
                console.error('加载仪表盘数据失败:', error);
            }
        }
        
        // 加载最近注册的用户
        async function loadRecentUsers() {
            try {
                const response = await fetch('/api/users?page=1&limit=5&sort=created_at:desc', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('获取最近用户失败');
                }
                
                const data = await response.json();
                
                const tableBody = document.getElementById('recent-users-table-body');
                tableBody.innerHTML = '';
                
                if (!data.data.users || data.data.users.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">暂无用户数据</td></tr>';
                    return;
                }
                
                // 渲染用户列表
                data.data.users.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td>${new Date(user.created_at).toLocaleString()}</td>
                        <td>
                            <span style="color: ${user.is_active ? 'green' : 'red'}">
                                ${user.is_active ? '活跃' : '禁用'}
                            </span>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            } catch (error) {
                console.error('加载最近用户失败:', error);
                document.getElementById('recent-users-table-body').innerHTML = 
                    '<tr><td colspan="5" style="text-align: center; color: red;">获取最近用户失败</td></tr>';
            }
        }
        
        // 加载最新上传的视频
        async function loadRecentVideos() {
            try {
                const response = await fetch('/api/videos?page=1&limit=5&sort=created_at:desc', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('获取最新视频失败');
                }
                
                const data = await response.json();
                
                const tableBody = document.getElementById('recent-videos-table-body');
                tableBody.innerHTML = '';
                
                if (!data.data.videos || data.data.videos.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暂无视频数据</td></tr>';
                    return;
                }
                
                // 渲染视频列表
                data.data.videos.forEach(video => {
                    const tr = document.createElement('tr');
                    
                    // 格式化时长
                    const formatDuration = (seconds) => {
                        if (!seconds) return '未知';
                        const min = Math.floor(seconds / 60);
                        const sec = Math.floor(seconds % 60);
                        return `${min}:${sec.toString().padStart(2, '0')}`;
                    };
                    
                    tr.innerHTML = `
                        <td>${video.id}</td>
                        <td>
                            ${video.thumbnail_path 
                                ? `<img src="/uploads/${video.thumbnail_path}" alt="${video.title}" style="width: 80px; height: 45px; object-fit: cover;">` 
                                : '无缩略图'}
                        </td>
                        <td>${video.title}</td>
                        <td>${video.user_id ? `用户ID: ${video.user_id}` : '未知'}</td>
                        <td>${new Date(video.created_at).toLocaleString()}</td>
                        <td>${formatDuration(video.duration)}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            } catch (error) {
                console.error('加载最新视频失败:', error);
                document.getElementById('recent-videos-table-body').innerHTML = 
                    '<tr><td colspan="6" style="text-align: center; color: red;">获取最新视频失败</td></tr>';
            }
        }
        
        // 加载系统信息
        async function loadSystemInfo() {
            try {
                const response = await fetch('/api/system/info', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('获取系统信息失败');
                }
                
                const data = await response.json();
                const info = data.data;
                
                // 更新系统信息
                document.getElementById('node-version').textContent = info.nodeVersion || '未知';
                document.getElementById('os-info').textContent = info.osInfo || '未知';
                document.getElementById('memory-usage').textContent = info.memoryUsage || '未知';
                document.getElementById('db-size').textContent = info.dbSize || '未知';
                document.getElementById('upload-size').textContent = info.uploadSize || '未知';
                document.getElementById('uptime').textContent = info.uptime || '未知';
            } catch (error) {
                console.error('加载系统信息失败:', error);
                
                // 更新为错误信息
                const elements = [
                    'node-version', 'os-info', 'memory-usage', 
                    'db-size', 'upload-size', 'uptime'
                ];
                
                elements.forEach(id => {
                    document.getElementById(id).textContent = '获取失败';
                });
            }
        }
        
        // 退出登录
        document.getElementById('logout-btn').addEventListener('click', async function() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/admin/index.html';
            } catch (error) {
                console.error('退出失败:', error);
            }
        });
        
        // 页面加载完成后检查认证并加载数据
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html> 